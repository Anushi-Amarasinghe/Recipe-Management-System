<div class="top-bar">
  <h2>ðŸ‘‘ Admin Panel</h2>
  <p>User Management</p>
</div>

<div class="admin-stats" id="adminStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
  <!-- Stats will be loaded here -->
</div>

<div class="admin-controls" style="margin-bottom: 20px;">
  <button id="refreshUsersBtn" class="btn-primary">ðŸ”„ Refresh</button>
  <input type="search" id="userSearch" placeholder="Search users..." style="margin-left: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
</div>

<div class="users-table-container" style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
  <table class="users-table" style="width: 100%; border-collapse: collapse;">
    <thead>
      <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
        <th style="padding: 12px; text-align: left;">Name</th>
        <th style="padding: 12px; text-align: left;">Email</th>
        <th style="padding: 12px; text-align: left;">Role</th>
        <th style="padding: 12px; text-align: left;">Status</th>
        <th style="padding: 12px; text-align: left;">Created</th>
        <th style="padding: 12px; text-align: left;">Actions</th>
      </tr>
    </thead>
    <tbody id="usersTableBody">
      <tr>
        <td colspan="6" style="padding: 20px; text-align: center; color: #6c757d;">Loading users...</td>
      </tr>
    </tbody>
  </table>
</div>

<script>
// Admin panel functionality
(async function() {
  // Check if user is admin
  if (typeof window.isAdmin !== "function" || !window.isAdmin()) {
    document.getElementById("mainContent").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <h2>Access Denied</h2>
        <p>You must be an admin to access this page.</p>
        <button onclick="window.history.back()" class="btn-primary" style="margin-top: 20px;">Go Back</button>
      </div>
    `;
    return;
  }

  let allUsers = [];

  // Load admin statistics
  async function loadStats() {
    try {
      // Get token using centralized utility
      let token = null;
      if (window.tokenStorage && window.tokenStorage.getToken) {
        token = window.tokenStorage.getToken();
      } else {
        token = localStorage.getItem("token");
      }
      const res = await fetch("/api/admin/stats", {
        headers: { "Authorization": "Bearer " + token }
      });

      if (!res.ok) throw new Error("Failed to load stats");

      const data = await res.json();
      const stats = data.stats;

      document.getElementById("adminStats").innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 10px 0; color: #6c757d; font-size: 14px;">Total Users</h3>
          <p style="margin: 0; font-size: 32px; font-weight: bold; color: #495057;">${stats.totalUsers}</p>
        </div>
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 10px 0; color: #6c757d; font-size: 14px;">Active Users</h3>
          <p style="margin: 0; font-size: 32px; font-weight: bold; color: #51cf66;">${stats.activeUsers}</p>
        </div>
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 10px 0; color: #6c757d; font-size: 14px;">Admins</h3>
          <p style="margin: 0; font-size: 32px; font-weight: bold; color: #ff6b6b;">${stats.adminUsers}</p>
        </div>
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 10px 0; color: #6c757d; font-size: 14px;">Regular Users</h3>
          <p style="margin: 0; font-size: 32px; font-weight: bold; color: #339af0;">${stats.regularUsers}</p>
        </div>
      `;
    } catch (err) {
      console.error("Error loading stats:", err);
    }
  }

  // Load users
  async function loadUsers() {
    try {
      // Get token using centralized utility
      let token = null;
      if (window.tokenStorage && window.tokenStorage.getToken) {
        token = window.tokenStorage.getToken();
      } else {
        token = localStorage.getItem("token");
      }
      const res = await fetch("/api/admin/users", {
        headers: { "Authorization": "Bearer " + token }
      });

      if (!res.ok) throw new Error("Failed to load users");

      const data = await res.json();
      allUsers = data.users;
      displayUsers(allUsers);
    } catch (err) {
      document.getElementById("usersTableBody").innerHTML = `
        <tr>
          <td colspan="6" style="padding: 20px; text-align: center; color: #ff6b6b;">
            Error loading users: ${err.message}
          </td>
        </tr>
      `;
    }
  }

  // Display users in table
  function displayUsers(users) {
    if (users.length === 0) {
      document.getElementById("usersTableBody").innerHTML = `
        <tr>
          <td colspan="6" style="padding: 20px; text-align: center; color: #6c757d;">No users found</td>
        </tr>
      `;
      return;
    }

    const tbody = document.getElementById("usersTableBody");
    tbody.innerHTML = users.map(user => {
      const createdDate = new Date(user.created_date).toLocaleDateString();
      const statusBadge = user.active === 1 
        ? '<span style="background: #51cf66; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">Active</span>'
        : '<span style="background: #ff6b6b; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">Inactive</span>';
      const roleBadge = user.role === "admin"
        ? '<span style="background: #ff6b6b; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">Admin</span>'
        : '<span style="background: #339af0; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">User</span>';

      return `
        <tr style="border-bottom: 1px solid #dee2e6;">
          <td style="padding: 12px;">${user.f_name} ${user.l_name}</td>
          <td style="padding: 12px;">${user.email}</td>
          <td style="padding: 12px;">${roleBadge}</td>
          <td style="padding: 12px;">${statusBadge}</td>
          <td style="padding: 12px;">${createdDate}</td>
          <td style="padding: 12px;">
            <button onclick="toggleUserRole('${user._id}', '${user.role}')" style="padding: 4px 8px; margin-right: 5px; border: none; border-radius: 4px; cursor: pointer; background: #339af0; color: white; font-size: 12px;">
              ${user.role === "admin" ? "Make User" : "Make Admin"}
            </button>
            <button onclick="toggleUserStatus('${user._id}', ${user.active})" style="padding: 4px 8px; margin-right: 5px; border: none; border-radius: 4px; cursor: pointer; background: ${user.active === 1 ? "#ff6b6b" : "#51cf66"}; color: white; font-size: 12px;">
              ${user.active === 1 ? "Deactivate" : "Activate"}
            </button>
          </td>
        </tr>
      `;
    }).join("");
  }

  // Toggle user role
  window.toggleUserRole = async function(userId, currentRole) {
    const newRole = currentRole === "admin" ? "user" : "admin";
    if (!confirm(`Are you sure you want to change this user's role to ${newRole}?`)) return;

    try {
      // Get token using centralized utility
      let token = null;
      if (window.tokenStorage && window.tokenStorage.getToken) {
        token = window.tokenStorage.getToken();
      } else {
        token = localStorage.getItem("token");
      }
      const res = await fetch(`/api/admin/users/${userId}/role`, {
        method: "PUT",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ role: newRole })
      });

      const data = await res.json();

      if (!res.ok) {
        alert(data.error?.message || "Failed to update role");
        return;
      }

      alert("User role updated successfully!");
      await loadUsers();
      await loadStats();
    } catch (err) {
      alert("Error updating user role: " + err.message);
    }
  };

  // Toggle user status
  window.toggleUserStatus = async function(userId, currentStatus) {
    const newStatus = currentStatus === 1 ? 0 : 1;
    const action = newStatus === 1 ? "activate" : "deactivate";
    if (!confirm(`Are you sure you want to ${action} this user?`)) return;

    try {
      // Get token using centralized utility
      let token = null;
      if (window.tokenStorage && window.tokenStorage.getToken) {
        token = window.tokenStorage.getToken();
      } else {
        token = localStorage.getItem("token");
      }
      const res = await fetch(`/api/admin/users/${userId}/status`, {
        method: "PUT",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ active: newStatus })
      });

      const data = await res.json();

      if (!res.ok) {
        alert(data.error?.message || "Failed to update status");
        return;
      }

      alert(`User ${action}d successfully!`);
      await loadUsers();
      await loadStats();
    } catch (err) {
      alert("Error updating user status: " + err.message);
    }
  };

  // Search functionality
  document.getElementById("userSearch").addEventListener("input", (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const filtered = allUsers.filter(user => 
      user.f_name.toLowerCase().includes(searchTerm) ||
      user.l_name.toLowerCase().includes(searchTerm) ||
      user.email.toLowerCase().includes(searchTerm)
    );
    displayUsers(filtered);
  });

  // Refresh button
  document.getElementById("refreshUsersBtn").addEventListener("click", async () => {
    await loadUsers();
    await loadStats();
  });

  // Initial load
  await loadStats();
  await loadUsers();
})();
</script>

